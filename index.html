<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back to 360 - Fix & Share</title>
    
    <script src="https://cdn.jsdelivr.net/npm/exifreader@4.12.0/dist/exif-reader.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; text-align: center; background: #f0f4f8; padding: 20px; color: #333; margin: 0; }
        .card { max-width: 480px; margin: 10px auto; background: white; padding: 25px; border-radius: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); }
        h1 { color: #2c3e50; margin-bottom: 5px; font-size: 28px; }
        .subtitle { color: #7f8c8d; margin-bottom: 25px; font-size: 14px; }
        .section { background: #f8f9fa; padding: 20px; border-radius: 18px; margin-bottom: 20px; border: 1px solid #e1e8ed; }
        h3 { margin-top: 0; color: #34495e; font-size: 18px; }
        .drop-zone { border: 2px dashed #3498db; padding: 25px; border-radius: 15px; cursor: pointer; background: #fff; transition: 0.3s; }
        .drop-zone:hover { background: #eef7fe; }
        #stato { margin: 15px 0; font-weight: bold; color: #2980b9; min-height: 20px; }
        .btn { background: #27ae60; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 16px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        .btn-share { background: #3498db; }
        .btn-receive { background: #8e44ad; }
        #qrcode { background: white; padding: 15px; display: inline-block; margin: 15px auto; border: 1px solid #ddd; border-radius: 10px; min-width: 150px; min-height: 150px; }
        #qrcode img { margin: 0 auto; }
        .code-display { font-size: 18px; color: #2c3e50; font-family: monospace; font-weight: bold; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd; word-break: break-all; }
        input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; text-align: center; font-size: 16px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>Back to 360</h1>
    <p class="subtitle">Scegli cosa vuoi fare:</p>
    
    <div class="section">
        <h3>üì• Ricevi una foto</h3>
        <input type="text" id="inputCodiceAmico" placeholder="Codice amico o QR">
        <button class="btn btn-receive" onclick="connettiERicevi()">Connetti e Ricevi</button>
    </div>

    <div id="stato">Inizializzazione sistema...</div>

    <div class="section">
        <h3>üì§ Ripara e Invia</h3>
        <div class="drop-zone" onclick="document.getElementById('inputFoto').click()">
            <span id="label">Seleziona la foto panoramica</span>
            <input type="file" id="inputFoto" accept="image/jpeg" style="display:none">
        </div>
        
        <button id="btnRipara" class="btn hidden" onclick="processaFoto()">ü™Ñ Ripara Metadati 360</button>

        <div id="downloadArea" class="hidden">
            <p style="color: #27ae60; font-weight: bold;">‚ú® Foto riparata!</p>
            <a id="linkDownload" href="#" class="btn" style="text-decoration:none; display:block; line-height:20px; box-sizing:border-box;">üíæ Scarica Locale</a>
            
            <hr>
            <p><small>Fai inquadrare questo QR per inviare:</small></p>
            <div id="qrcode"></div>
            <div id="mioIDDisplay" class="code-display">Generazione codice...</div>
        </div>
    </div>
</div>

<script>
    let fileOriginale = null;
    let blobRiparato = null;
    let peer = null;

    const stato = document.getElementById('stato');
    const inputFoto = document.getElementById('inputFoto');
    const btnRipara = document.getElementById('btnRipara');
    const downloadArea = document.getElementById('downloadArea');
    const mioIDDisplay = document.getElementById('mioIDDisplay');
    const qrcodeDiv = document.getElementById('qrcode');
    const inputCodiceAmico = document.getElementById('inputCodiceAmico');

    // DOMINIO UFFICIALE
    const DOMINIO = "https://marcaugel.github.io/back-to-360/";

    peer = new Peer();
    
    peer.on('open', (id) => {
        stato.innerText = "Sistema pronto";
        mioIDDisplay.innerText = id;
        generaQR(id);
        controllaURL(id);
    });

    peer.on('error', (err) => {
        stato.innerText = "Errore connessione";
        console.error(err);
    });

    function generaQR(id) {
        const urlCondivisione = DOMINIO + "#connect=" + id;
        qrcodeDiv.innerHTML = ""; 
        new QRCode(qrcodeDiv, {
            text: urlCondivisione,
            width: 150,
            height: 150,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }

    function controllaURL(mioID) {
        const hash = window.location.hash;
        if (hash.includes("connect=")) {
            const idAmico = hash.split("connect=")[1];
            if (idAmico && idAmico !== mioID) {
                inputCodiceAmico.value = idAmico;
                stato.innerText = "Codice QR rilevato!";
                // Opzionale: connettiERicevi(); // Scommenta per connessione immediata al QR
            }
        }
    }

    inputFoto.addEventListener('change', async (e) => {
        fileOriginale = e.target.files[0];
        if (!fileOriginale) return;
        stato.innerText = "Analisi file...";
        try {
            const tags = await ExifReader.load(fileOriginale);
            const is360 = tags['ProjectionType'] || tags['GPano:ProjectionType'];
            if (is360) {
                stato.innerText = "‚úÖ Foto gi√† 360.";
                btnRipara.classList.add('hidden');
                downloadArea.classList.remove('hidden');
            } else {
                stato.innerText = "‚ùå Metadati mancanti.";
                btnRipara.classList.remove('hidden');
                downloadArea.classList.add('hidden');
            }
        } catch (err) { stato.innerText = "Errore file JPEG."; }
    });

    function processaFoto() {
        const reader = new FileReader();
        reader.onload = function(e) {
            const uint8 = new Uint8Array(e.target.result);
            const xmpStr = `http://ns.adobe.com/xap/1.0/\0<?xpacket begin="" id="W5M0MpCehiHzreSzNTczkc9d"?><x:xmpmeta xmlns:x="adobe:ns:meta/"><rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><rdf:Description rdf:about="" xmlns:GPano="http://ns.google.com/photos/1.0/panorama/"><GPano:ProjectionType>equirectangular</GPano:ProjectionType><GPano:UsePanoramaViewer>True</GPano:UsePanoramaViewer><GPano:FullPanoWidthPixels>4000</GPano:FullPanoWidthPixels><GPano:FullPanoHeightPixels>2000</GPano:FullPanoHeightPixels></rdf:Description></rdf:RDF></x:xmpmeta><?xpacket end="w"?>`;
            const xmpBytes = new TextEncoder().encode(xmpStr);
            const xmpLen = xmpBytes.length + 2;
            const app1 = new Uint8Array([0xFF, 0xE1, (xmpLen >> 8) & 0xFF, xmpLen & 0xFF]);
            const finale = new Uint8Array(uint8.length + app1.length + xmpBytes.length);
            finale.set(uint8.slice(0, 2), 0);
            finale.set(app1, 2);
            finale.set(xmpBytes, 6);
            finale.set(uint8.slice(2), 6 + xmpBytes.length);
            blobRiparato = new Blob([finale], {type: "image/jpeg"});
            document.getElementById('linkDownload').href = URL.createObjectURL(blobRiparato);
            document.getElementById('linkDownload').download = "360_" + fileOriginale.name;
            stato.innerText = "‚ú® Foto riparata!";
            btnRipara.classList.add('hidden');
            downloadArea.classList.remove('hidden');
        };
        reader.readAsArrayBuffer(fileOriginale);
    }

    peer.on('connection', (conn) => {
        conn.on('open', () => {
            stato.innerText = "Invio in corso...";
            conn.send({ 
                file: blobRiparato || fileOriginale, 
                name: "BackTo360_" + (fileOriginale ? fileOriginale.name : "photo.jpg") 
            });
        });
    });

    function connettiERicevi() {
        const id = inputCodiceAmico.value.trim();
        if(!id) return alert("Inserisci il codice!");
        stato.innerText = "Connessione...";
        const conn = peer.connect(id);
        conn.on('data', (data) => {
            if (data.file) {
                const url = URL.createObjectURL(new Blob([data.file]));
                const a = document.createElement('a');
                a.href = url; a.download = data.name; a.click();
                stato.innerText = "üéÅ Ricevuta!";
            }
        });
        conn.on('open', () => stato.innerText = "Connesso! Ricezione...");
    }
</script>

</body>
</html>